<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking - LANXIANG TCM</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* CSS Cũ của bạn */
        .loading-spinner { display: none; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .submit-btn-container { position: relative; }
        .submit-btn:disabled { background: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .phone-validation { color: #e74c3c; font-size: 0.9em; margin-top: 5px; display: none; }

        /* CSS Mới cho danh sách nhân viên */
        #staff-availability-container { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-top: 15px; display: none; }
        .staff-list { list-style-type: none; padding: 0; margin: 0; }
        .staff-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; cursor: pointer; transition: background-color 0.2s; }
        .staff-item:last-child { border-bottom: none; }
        .staff-item:hover { background-color: #f0f0f0; }
        .staff-item input[type="radio"] { margin-right: 15px; transform: scale(1.2); }
        .staff-name { font-weight: bold; flex-grow: 1; }
        .staff-status { font-size: 0.9em; padding: 3px 8px; border-radius: 12px; color: white; }
        .status-available { background-color: #2ecc71; }
        .status-busy { background-color: #e74c3c; }
        #staff-loading { text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div class="top-contact-bar">...</div>
    <header>...</header>
    <nav>...</nav>

    <main class="container">
        <h2>Book an Appointment / <span lang="zh-CN">预约</span></h2>
        
        <div id="apiErrorMessage" class="error-message" style="display:none;"></div>
        <div id="successMessage" class="success-message" style="display:none;">...</div>

        <form id="bookingForm">
            <p id="form-description">...</p>
            
            <div class="form-line"><label for="fullName">...</label></div>
            <div class="form-line"><input type="text" id="fullName" ...></div>
            <div class="form-line"><label for="bookingDateTime">...</label></div>
            <div class="form-line"><input type="datetime-local" id="bookingDateTime" ...></div>
            <div class="form-line"><label for="service">...</label></div>
            <div class="form-line"><select id="service" ...>...</select></div>
            
            <div class="form-line"><label>Preferred Staff (Optional) / <span lang="zh-CN">按摩师 (选填)</span></label></div>
            
            <div id="staff-availability-container">
                <div id="staff-loading" style="display: none;">...</div>
                <ul class="staff-list" id="staff-list"></ul>
            </div>
            
            <div class="form-line"><label for="phone">...</label>...</div>
            <div class="form-line"><input type="tel" id="phone" ...></div>
            
            <div class="form-line submit-btn-container">
                <button type="submit" id="submitButton" class="submit-btn">...</button>
            </div>
        </form>
    </main>
    
    <footer>...</footer>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const RENDER_API_URL = 'https://lanxiang-api.onrender.com'; // Thay URL của bạn vào đây nếu khác
            
            // Lấy các element từ DOM
            const bookingForm = document.getElementById('bookingForm');
            const submitButton = document.getElementById('submitButton');
            const successMessageDiv = document.getElementById('successMessage');
            const apiErrorMessageDiv = document.getElementById('apiErrorMessage');
            const bookingDateField = document.getElementById('bookingDateTime');
            const staffContainer = document.getElementById('staff-availability-container');
            const staffList = document.getElementById('staff-list');
            const staffLoading = document.getElementById('staff-loading');

            // --- PHẦN 1: LẤY VÀ HIỂN THỊ TRẠNG THÁI NHÂN VIÊN ---

            async function fetchStaffAvailability(dateTimeValue) {
                if (!dateTimeValue) {
                    staffContainer.style.display = 'none';
                    return;
                }
                
                staffContainer.style.display = 'block';
                staffList.innerHTML = ''; 
                staffLoading.style.display = 'block';
                staffLoading.innerHTML = '<p>Loading staff list...</p>';

                try {
                    const isoDate = new Date(dateTimeValue);
                    const formattedDate = isoDate.getFullYear() + '-' + ('0' + (isoDate.getMonth() + 1)).slice(-2) + '-' + ('0' + isoDate.getDate()).slice(-2);

                    const response = await fetch(`${RENDER_API_URL}/api/staff-availability?date=${formattedDate}`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.details || 'API server error');
                    }
                    displayStaff(data.staff_availability);

                } catch (error) {
                    staffLoading.style.display = 'block';
                    staffList.innerHTML = '';
                    staffLoading.innerHTML = `<p style="color:red;">Could not load staff list: ${error.message}</p>`;
                }
            }

            function displayStaff(staffData) {
                staffLoading.style.display = 'none';
                staffList.innerHTML = '';

                if (!staffData || staffData.length === 0) {
                    staffList.innerHTML = '<li>No staff available for the selected date.</li>';
                    return;
                }

                // Thêm lựa chọn "Không chọn"
                const noPreferenceItem = document.createElement('li');
                noPreferenceItem.className = 'staff-item';
                noPreferenceItem.innerHTML = `<input type="radio" id="staff-none" name="staffChoice" value="" checked><label for="staff-none" class="staff-name">No Preference / 随便</label>`;
                noPreferenceItem.onclick = () => document.getElementById('staff-none').checked = true;
                staffList.appendChild(noPreferenceItem);

                // Hiển thị danh sách nhân viên
                staffData.forEach(staff => {
                    const listItem = document.createElement('li');
                    listItem.className = 'staff-item';
                    const statusClass = staff.status === 'Available' ? 'status-available' : 'status-busy';
                    const statusText = staff.status === 'Available' ? 'Available / 空闲' : `Wait ${staff.wait_time_minutes} min / 预计等待 ${staff.wait_time_minutes} 分钟`;
                    const uniqueId = `staff-${staff.name.replace(/[^a-zA-Z0-9]/g, '')}`;

                    listItem.innerHTML = `<input type="radio" id="${uniqueId}" name="staffChoice" value="${staff.name}"><label for="${uniqueId}" class="staff-name">${staff.name}</label><span class="staff-status ${statusClass}">${statusText}</span>`;
                    listItem.onclick = () => document.getElementById(uniqueId).checked = true;
                    staffList.appendChild(listItem);
                });
            }

            // Gắn sự kiện vào ô chọn ngày
            let debounceTimer;
            bookingDateField.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => fetchStaffAvailability(bookingDateField.value), 500);
            });


            // --- PHẦN 2: XỬ LÝ GỬI FORM ---
            
            bookingForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                apiErrorMessageDiv.style.display = 'none';

                // Lấy thông tin từ form
                const fullName = document.getElementById('fullName').value;
                const dateTimeValue = document.getElementById('bookingDateTime').value;
                const service = document.getElementById('service').value;
                const phone = document.getElementById('phone').value;
                const selectedStaffRadio = document.querySelector('input[name="staffChoice"]:checked');
                const preferredStaff = selectedStaffRadio ? selectedStaffRadio.value : '';

                if (!preferredStaff) {
                    alert('Please select a staff member or "No Preference".\n请选择一位按摩师或"随便"。');
                    return;
                }

                submitButton.disabled = true;
                // Hiển thị loading spinner...

                try {
                    const response = await fetch(`${RENDER_API_URL}/api/bookings`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fullName,
                            bookingDateTime: dateTimeValue,
                            service,
                            preferredStaff,
                            phoneNumber: phone
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        // Nếu API trả lỗi (ví dụ 409 - Conflict), hiển thị lỗi đó
                        throw new Error(result.message || 'An error occurred.');
                    }

                    // Nếu thành công, hiển thị thông báo thành công
                    // (Bạn có thể thêm code để điền vào các span `confirm_` nếu muốn)
                    bookingForm.style.display = 'none';
                    successMessageDiv.style.display = 'block';

                } catch (error) {
                    apiErrorMessageDiv.innerText = `Booking Failed: ${error.message}`;
                    apiErrorMessageDiv.style.display = 'block';
                } finally {
                    submitButton.disabled = false;
                    // Tắt loading spinner...
                }
            });
        });
    </script>
</body>
</html>
